<script lang="ts">
  import { Link, useNavigate } from 'svelte-navigator';
  import { FlatButton } from 'components';
  import { claimsStream, contractAddress, userData, wallet } from 'src/store';
  import { addDefaults } from 'src/helpers';
  import { TZProfileLogo } from 'components';
  import { CopyButton } from 'components/buttons';
  import './nav.scss';

  let navigate = useNavigate();

  const unprotected = [
    '/BasicProfile',
    '/TwitterVerification',
    '/TwitterVerificationPublicTweet',
    '/handle',
    '/timestamp',
    '/tweetId',
    '/connect',
    '/deploy',
    '/faq',
    '/privacy-policy',
    '/search',
    '/terms-of-service',
    '/view',
  ];
  const path = window.location.pathname;
  let isAdminDropdownOpen = false;

  let isUnprotected = false;

  for (let i = 0, n = unprotected.length; i < n; i++) {
    let prefix = unprotected[i];
    if (path.startsWith(prefix)) {
      isUnprotected = true;
      break;
    }
  }

  if ($userData === null && !isUnprotected) navigate('/');
</script>

<nav
  class="flex justify-between px-4 md:px-12 pt-4 md:pt-8 pb-4 text-white fixed top-0 left-0 z-10 w-full bg-blue-light"
>
  <div class="cursor-pointer flex flex-row items-center">
    <a href="https://www.gaia-x4futuremobility.dlr.de/" target="_blank"
      ><TZProfileLogo class="sm:h-12 h-8" /></a
    >
  </div>
  <div />
  <div class="flex flex-row items-center">
    {#if $userData}
      <div class="relative sm:ml-6 ml-2 hidden sm:flex">
        <div
          class="flex flex-row items-center address-container py-3 px-4 cursor-pointer overall-wallet-container"
        >
          <div
            class="address-text-container cursor-pointer mr-2"
            on:click={() => (isAdminDropdownOpen = !isAdminDropdownOpen)}
          >
            DID:
            <strong>
              {$userData.account.address.slice(
                0,
                5
              )}...{$userData.account.address.slice(-4)}
            </strong>
          </div>
          <CopyButton
            text={$userData.account.address}
            color="gray"
            class="w-4 h-4"
          />
        </div>
        {#if isAdminDropdownOpen && $wallet}
          <div class="admin-dropdown-pane">
            <FlatButton
              onClick={() =>
                $wallet.disconnect().then(() => {
                  // TODO: Track state more carefully / explicitly.
                  wallet.set(null);
                  userData.set(null);
                  claimsStream.set(addDefaults({}));
                  contractAddress.set(null);
                  navigate('/');
                })}
              text="Disconnect"
              class="mx-4 body"
            />
          </div>
        {/if}
      </div>
    {/if}
    <div class="body font-semibold ml-2 sm:ml-6 ml-4 hidden sm:flex">
      <a
        href=" https://github.com/GAIA-X4PLC-AAD/gx-credentials"
        target="_blank"
      >
        GX-Credentials</a
      >
    </div>
    <!-- {#if $userData}
      <Link to="/connect" class="sm:ml-6 ml-4 body font-semibold"
        >Company Profile</Link
      >
    {/if} -->

    <!-- <Link to="/search" class="sm:ml-6 ml-4 body font-semibold"
      >Search Profiles</Link -->
    <!-- > -->
    <!-- {#if !$wallet}
      <Link to="/faq" class="sm:ml-6 ml-4 body font-semibold">FAQ</Link>
    {/if} -->
  </div>
</nav>
